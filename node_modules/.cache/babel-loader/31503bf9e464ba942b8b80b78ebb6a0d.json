{"ast":null,"code":"'use strict';\n\nvar constants = require('./constants');\n\nmodule.exports = function (data, width, height, options) {\n  var outHasAlpha = options.colorType === constants.COLORTYPE_COLOR_ALPHA;\n\n  if (options.inputHasAlpha && outHasAlpha) {\n    return data;\n  }\n\n  if (!options.inputHasAlpha && !outHasAlpha) {\n    return data;\n  }\n\n  var outBpp = outHasAlpha ? 4 : 3;\n  var outData = new Buffer(width * height * outBpp);\n  var inBpp = options.inputHasAlpha ? 4 : 3;\n  var inIndex = 0;\n  var outIndex = 0;\n  var bgColor = options.bgColor || {};\n\n  if (bgColor.red === undefined) {\n    bgColor.red = 255;\n  }\n\n  if (bgColor.green === undefined) {\n    bgColor.green = 255;\n  }\n\n  if (bgColor.blue === undefined) {\n    bgColor.blue = 255;\n  }\n\n  for (var y = 0; y < height; y++) {\n    for (var x = 0; x < width; x++) {\n      var red = data[inIndex];\n      var green = data[inIndex + 1];\n      var blue = data[inIndex + 2];\n      var alpha;\n\n      if (options.inputHasAlpha) {\n        alpha = data[inIndex + 3];\n\n        if (!outHasAlpha) {\n          alpha /= 255;\n          red = Math.min(Math.max(Math.round((1 - alpha) * bgColor.red + alpha * red), 0), 255);\n          green = Math.min(Math.max(Math.round((1 - alpha) * bgColor.green + alpha * green), 0), 255);\n          blue = Math.min(Math.max(Math.round((1 - alpha) * bgColor.blue + alpha * blue), 0), 255);\n        }\n      } else {\n        alpha = 255;\n      }\n\n      outData[outIndex] = red;\n      outData[outIndex + 1] = green;\n      outData[outIndex + 2] = blue;\n\n      if (outHasAlpha) {\n        outData[outIndex + 3] = alpha;\n      }\n\n      inIndex += inBpp;\n      outIndex += outBpp;\n    }\n  }\n\n  return outData;\n};","map":null,"metadata":{},"sourceType":"script"}