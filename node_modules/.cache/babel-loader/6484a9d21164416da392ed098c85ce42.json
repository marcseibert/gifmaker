{"ast":null,"code":"'use strict';\n\nvar ContentStream = require('contentstream');\n\nvar GifEncoder = require('gif-encoder');\n\nvar jpegJs = require('jpeg-js');\n\nvar PNG = require('pngjs-nozlib').PNG;\n\nvar ndarray = require('ndarray');\n\nvar ops = require('ndarray-ops');\n\nvar through = require('through');\n\nfunction handleData(array, data, frame) {\n  var i,\n      j,\n      ptr = 0,\n      c;\n\n  if (array.shape.length === 4) {\n    return handleData(array.pick(frame), data, 0);\n  } else if (array.shape.length === 3) {\n    if (array.shape[2] === 3) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), array);\n      ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n    } else if (array.shape[2] === 4) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 4], [4, array.shape[0] * 4, 1]), array);\n    } else if (array.shape[2] === 1) {\n      ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), ndarray(array.data, [array.shape[0], array.shape[1], 3], [array.stride[0], array.stride[1], 0], array.offset));\n      ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n    } else {\n      return new Error('Incompatible array shape');\n    }\n  } else if (array.shape.length === 2) {\n    ops.assign(ndarray(data, [array.shape[0], array.shape[1], 3], [4, 4 * array.shape[0], 1]), ndarray(array.data, [array.shape[0], array.shape[1], 3], [array.stride[0], array.stride[1], 0], array.offset));\n    ops.assigns(ndarray(data, [array.shape[0] * array.shape[1]], [4], 3), 255);\n  } else {\n    return new Error('Incompatible array shape');\n  }\n\n  return data;\n}\n\nfunction haderror(err) {\n  var result = through();\n  result.emit('error', err);\n  return result;\n}\n\nmodule.exports = function savePixels(array, type, options) {\n  options = options || {};\n\n  switch (type.toUpperCase()) {\n    case 'JPG':\n    case '.JPG':\n    case 'JPEG':\n    case '.JPEG':\n    case 'JPE':\n    case '.JPE':\n      var width = array.shape[0];\n      var height = array.shape[1];\n      var data = new Buffer(width * height * 4);\n      data = handleData(array, data);\n      var rawImageData = {\n        data: data,\n        width: width,\n        height: height\n      };\n      var jpegImageData = jpegJs.encode(rawImageData, options.quality);\n      return new ContentStream(jpegImageData.data);\n\n    case 'GIF':\n    case '.GIF':\n      var frames = array.shape.length === 4 ? array.shape[0] : 1;\n      var width = array.shape.length === 4 ? array.shape[1] : array.shape[0];\n      var height = array.shape.length === 4 ? array.shape[2] : array.shape[1];\n      var data = new Buffer(width * height * 4);\n      var gif = new GifEncoder(width, height);\n      gif.writeHeader();\n\n      for (var i = 0; i < frames; i++) {\n        data = handleData(array, data, i);\n        gif.addFrame(data);\n      }\n\n      gif.finish();\n      return gif;\n\n    case 'PNG':\n    case '.PNG':\n      var png = new PNG({\n        width: array.shape[0],\n        height: array.shape[1]\n      });\n      var data = handleData(array, png.data);\n      if (typeof data === 'Error') return haderror(data);\n      png.data = data;\n      return png.pack();\n\n    case 'CANVAS':\n      var canvas = document.createElement('canvas');\n      var context = canvas.getContext('2d');\n      canvas.width = array.shape[0];\n      canvas.height = array.shape[1];\n      var imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n      var data = imageData.data;\n      data = handleData(array, data);\n      if (typeof data === 'Error') return haderror(data);\n      context.putImageData(imageData, 0, 0);\n      return canvas;\n\n    default:\n      return haderror(new Error('Unsupported file type: ' + type));\n  }\n};","map":null,"metadata":{},"sourceType":"script"}